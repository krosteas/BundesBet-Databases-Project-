<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BundesBet — Upcoming Matches & Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Shared styles -->
  <link rel="stylesheet" href="app.css" />

  <!-- jQuery + jQuery UI (for autocomplete) -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>

  <!-- Leaflet (map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
</head>
<body>
  <header class="site-header">
    <div class="container nav">
      <a class="brand" href="index.html">
        <span class="brand-logo" aria-hidden="true"></span>
        <span class="brand-name">BundesBet</span>
      </a>
      <nav class="nav-links">
        <a class="active" href="index.html">Home</a>
        <a href="imprint.html">Imprint</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Search -->
    <section class="card">
      <h1>Search teams or players</h1>
      <div class="search-row">
        <input id="searchInput" class="input" type="search"
               placeholder="Type a team or player…" autocomplete="off" />
        <button id="searchBtn" class="btn">Search</button>
      </div>

      <div id="searchResults" class="search-results" hidden></div>

      <div id="searchEmpty" class="muted" hidden>No results.</div>
      <div id="searchError" class="error" hidden>Could not search. Please try again.</div>
    </section>

    <!-- Upcoming Matches -->
    <section class="card">
      <div class="section-head">
        <h2>Upcoming Matches</h2>
        <div class="muted">Live from database</div>
      </div>
      <div id="matchList" class="match-grid"></div>
      <div id="matchEmpty" class="muted" hidden>No upcoming matches scheduled.</div>
      <div id="matchError" class="error" hidden>Could not load matches. Please refresh.</div>
    </section>

    <!-- Geo / Map Section -->
    <section class="card">
      <div class="section-head">
        <h2>Your Region</h2>
        <div class="muted">Based on your IP address</div>
      </div>
      <div id="geoStatus" class="muted">Detecting your location…</div>
      <div id="geoError" class="error hidden">Could not determine your location.</div>
      <div id="map" style="margin-top:.8rem; height:320px; border-radius:16px; overflow:hidden;"></div>
    </section>
  </main>

  <footer class="container site-footer">
    <div class="muted">
      © 2025 Team BundesBet — Student lab work.
      <a href="imprint.html">Imprint</a>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Search wiring ---
      const input  = document.getElementById('searchInput');
      const btn    = document.getElementById('searchBtn');
      const listEl = document.getElementById('searchResults');
      const empty  = document.getElementById('searchEmpty');
      const errEl  = document.getElementById('searchError');

      async function runSearch() {
        const q = (input.value || '').trim();
        if (!q) return;
        listEl.innerHTML = '';
        listEl.hidden = true;
        empty.hidden = true;
        errEl.hidden = true;

        try {
          // API: api/search.php?q=...
          const res = await fetch(`api/search.php?q=${encodeURIComponent(q)}`);
          if (!res.ok) throw new Error('bad status');
          const data = await res.json(); // { query, teams:[...], players:[...] }

          const items = [];
          (data.teams || []).forEach(t => {
            items.push({
              type: 'team',
              id: t.team_id,
              title: t.name,
              subtitle: t.city || 'Team',
              href: `team.html?id=${encodeURIComponent(t.team_id)}`
            });
          });
          (data.players || []).forEach(p => {
            items.push({
              type: 'player',
              id: p.person_id,
              title: p.full_name,
              subtitle: p.position || 'Player',
              href: `player.html?id=${encodeURIComponent(p.person_id)}`
            });
          });

          if (!items.length) {
            empty.hidden = false;
            return;
          }

          listEl.hidden = false;
          for (const it of items) {
            const a = document.createElement('a');
            a.className = 'result-item';
            a.href = it.href;
            a.innerHTML = `
              <div class="pill pill-${it.type}">${it.type}</div>
              <div class="result-main">
                <div class="result-title">${escapeHtml(it.title)}</div>
                <div class="result-sub">${escapeHtml(it.subtitle || '')}</div>
              </div>`;
            listEl.appendChild(a);
          }
        } catch (e) {
          console.error(e);
          errEl.hidden = false;
        }
      }

      btn.addEventListener('click', runSearch);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') runSearch();
      });

      // === jQuery UI Autocomplete (styled, multiline) ===
      const $input = $('#searchInput');
      $input.autocomplete({
        minLength: 2,
        delay: 200,
        source: function (request, response) {
          fetch(`api/search.php?q=${encodeURIComponent(request.term)}`)
            .then(res => {
              if (!res.ok) throw new Error('bad status');
              return res.json();
            })
            .then(data => {
              const suggestions = [];

              // Teams
              (data.teams || []).forEach(t => {
                suggestions.push({
                  label: t.name,
                  value: t.name,
                  subtitle: t.city || 'Team',
                  type: 'team',
                  id: t.team_id
                });
              });

              // Players
              (data.players || []).forEach(p => {
                suggestions.push({
                  label: p.full_name,
                  value: p.full_name,
                  subtitle: p.position || 'Player',
                  type: 'player',
                  id: p.person_id
                });
              });

              response(suggestions);
            })
            .catch(err => {
              console.error(err);
              response([]);
            });
        },
        select: function (event, ui) {
          if (ui.item.type === 'team') {
            window.location.href = `team.html?id=${encodeURIComponent(ui.item.id)}`;
          } else if (ui.item.type === 'player') {
            window.location.href = `player.html?id=${encodeURIComponent(ui.item.id)}`;
          } else {
            $('#searchInput').val(ui.item.value);
          }
          return false;
        }
      });

      const acInstance = $input.autocomplete('instance');
      acInstance._renderItem = function (ul, item) {
        return $('<li>')
          .append(
            '<div class="ui-menu-item-wrapper">' +
              '<span class="ac-title">' + escapeHtml(item.label) + '</span>' +
              '<span class="ac-subtitle">' + escapeHtml(item.subtitle || '') + '</span>' +
            '</div>'
          )
          .appendTo(ul);
      };

      // --- Upcoming matches ---
      const matchList = document.getElementById('matchList');
      const matchEmpty = document.getElementById('matchEmpty');
      const matchError = document.getElementById('matchError');

      (async function loadUpcoming() {
        matchList.innerHTML = '';
        matchEmpty.hidden = true;
        matchError.hidden = true;

        try {
          // API: api/upcoming-matches.php
          const res = await fetch('api/upcoming-matches.php');
          if (!res.ok) throw new Error('bad status');
          const data = await res.json();

          if (!Array.isArray(data) || !data.length) {
            matchEmpty.hidden = false;
            return;
          }

          for (const m of data) {
            const card = document.createElement('a');
            card.className = 'match-card';
            card.href = `match.html?id=${encodeURIComponent(m.match_id)}`;
            const kickoff = fmtDateTime(m.kickoff_at);
            card.innerHTML = `
              <div class="match-row">
                <div class="team">${escapeHtml(m.home_team && m.home_team.name || 'Home')}</div>
                <div class="vs">vs</div>
                <div class="team">${escapeHtml(m.away_team && m.away_team.name || 'Away')}</div>
              </div>
              <div class="match-sub">
                <span class="when">${escapeHtml(kickoff)}</span>
                <span class="dot">•</span>
                <span class="where">${escapeHtml(m.venue || '')}</span>
              </div>`;
            matchList.appendChild(card);
          }
        } catch (e) {
          console.error(e);
          matchError.hidden = false;
        }
      })();

      // --- Geo / Map logic (client-side ipinfo) ---
      const geoStatus = document.getElementById('geoStatus');
      const geoError  = document.getElementById('geoError');
      const mapDiv    = document.getElementById('map');

      if (mapDiv && window.L) {
        // If you have an ipinfo token, put it here; otherwise leave empty.
        const ipinfoToken = ""; // e.g. "your_token_here"

        const url = ipinfoToken
          ? `https://ipinfo.io/json?token=${encodeURIComponent(ipinfoToken)}`
          : 'https://ipinfo.io/json';

        fetch(url)
          .then(res => {
            if (!res.ok) throw new Error('geo status ' + res.status);
            return res.json();
          })
          .then(data => {
            const ip      = data.ip || 'unknown IP';
            const city    = data.city || '';
            const region  = data.region || '';
            const country = data.country || '';
            const loc     = data.loc || null;

            if (!loc || loc.indexOf(',') === -1) {
              throw new Error('no loc');
            }

            const parts = loc.split(',');
            const lat   = parseFloat(parts[0]);
            const lon   = parseFloat(parts[1]);

            if (Number.isNaN(lat) || Number.isNaN(lon)) {
              throw new Error('invalid lat/lon');
            }

            const locationText = [city, region, country].filter(Boolean).join(', ');

            geoStatus.textContent = locationText
              ? `You appear to be near ${locationText} (IP: ${ip})`
              : `Your IP address: ${ip}`;

            const map = L.map('map').setView([lat, lon], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const popupText = locationText ? `${ip} — ${locationText}` : ip;

            L.marker([lat, lon])
              .addTo(map)
              .bindPopup(popupText)
              .openPopup();
          })
          .catch(err => {
            console.error('geo error', err);
            geoStatus.classList.add('hidden');
            geoError.classList.remove('hidden');
          });
      } else {
        geoStatus.classList.add('hidden');
        geoError.classList.remove('hidden');
        geoError.textContent = 'Map library could not be loaded.';
      }

      // ---- helpers ----
      function escapeHtml(s) {
        return String(s == null ? '' : s).replace(/[&<>"]/g, c => (
          {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]
        ));
      }
      function fmtDateTime(ts) {
        if (!ts) return '';
        const iso = ts.replace(' ', 'T');
        const d = new Date(iso);
        if (isNaN(d)) return ts;
        return d.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
      }
    });
  </script>
</body>
</html>
